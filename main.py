from stt.recognize import  recognize_continuous , recognize_wake_up


import tts


import queue
import re
import time
from time import sleep as pause


import torch

 # Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð¼Ð¾Ð´ÐµÐ»Ð¸ TTS ÑÐ¿ÐµÑ€Ð²Ð°
 # Ð¸ÑÐ¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¼Ð¾Ð´ÐµÐ»Ð¸, ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾
 # Ð¸ÑÐ¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð²Ñ‚Ð¾Ñ€Ð¾Ð¹ Ð¿Ð¾Ñ‚Ð¾Ðº Ñ‡Ñ‚Ð¾ Ð±Ñ‹ Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ð»ÑÑ stt Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ð¾ÑÐ»Ðµ Ð°ÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ð¸ tss
 # Ñ€Ð°Ð·Ð¾Ð±Ñ€Ð°Ñ‚ÑŒ Ð² Ð¿Ð°Ñ€Ð°Ð»ÐµÐ»ÑŒÐ½Ñ‹Ñ… Ð¿Ð¾Ñ‚Ð¾ÐºÐ¾Ð² Ð° Ð¿Ð¾ÐºÐ° Ð±Ð¾Ð»ÑŒÑˆÐµ Ð¿Ð¾Ñ‚Ð¾ÐºÐ¾Ð² Ð½Ðµ ÑÐ¾Ð·Ð´Ð°Ð²Ð°Ñ‚ÑŒ, Ð° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð¾Ð´Ð¸Ð½ Ð´Ð»Ñ Ñ€Ð°ÑÐ¿Ð¾Ð·Ð½Ð°Ð²Ð°Ð½Ð¸Ñ Ñ€ÐµÑ‡Ð¸
 # Ð² Ð±ÑƒÐ´ÑƒÑ‰ÐµÐ¼ Ð¼Ð¾Ð¶Ð½Ð¾ Ð±ÑƒÐ´ÐµÑ‚ ÑÐ´ÐµÐ»Ð°Ñ‚ÑŒ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ð¿Ð¾Ñ‚Ð¾ÐºÐ¾Ð² Ð´Ð»Ñ Ñ€Ð°ÑÐ¿Ð¾Ð·Ð½Ð°Ð²Ð°Ð½Ð¸Ñ Ñ€ÐµÑ‡Ð¸ Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ ÐºÐ¾Ð¼Ð°Ð½Ð´ 
 # Ñ‡ÐµÐ¼ Ð±Ð¾Ð»ÑŒÑˆÐµ Ð¿Ð¾Ñ‚Ð¾ÐºÐ¾Ð² Ñ‚ÐµÐ¼ Ð±Ð¾Ð»ÑŒÑˆÐµ Ð½Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð½Ð° Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ñ€ Ð¸ Ð¿Ð°Ð¼ÑÑ‚ÑŒ
 # Ð±Ð¾Ð»ÑŒÑˆÐµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ Ð³Ð¾Ð²Ð¾Ñ€ÑÑ‚ Ð¾Ð´Ð½Ð¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¾ Ñ‚Ð¾ Ð±Ð¾Ð»ÑŒÑˆÐµ Ð¿Ð¾Ñ‚Ð¾ÐºÐ¾Ð² Ñ€Ð°ÑÐ¿Ð¾Ð·Ð½Ð°Ð²Ð°Ð½Ð¸Ñ Ñ€Ð°Ð·Ð½Ð¾ÑˆÐ¾ Ð³Ð¾Ð»Ð¾ÑÐ° 

print("Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° TTS Ð¼Ð¾Ð´ÐµÐ»Ð¸...")
model = torch.hub.load('snakers4/silero-models', 'silero_tts', language='ru')
 # Ð¸Ð»Ð¸ 'cuda', ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ GPU
print("ÐœÐ¾Ð´ÐµÐ»ÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð° Ð¸ Ð³Ð¾Ñ‚Ð¾Ð²Ð° Ðº Ñ€Ð°Ð±Ð¾Ñ‚Ðµ.")




def process_command(cmd):
    cmd = cmd.lower()

    if "Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚ÑŒ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ" in cmd:
        print("ðŸ‘‹ ")
        print({"message": "Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ð¿Ð¾ ÐºÐ¾Ð¼Ð°Ð½Ð´Ðµ 'Ð¿Ð¾ÐºÐ°'."} )
        tts.va_speak("Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÑŽ Ð¿Ñ€Ð¾Ñ‚Ð¾ÐºÐ¾Ð» Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹")
        pause(1)  # ÐŸÐ°ÑƒÐ·Ð° Ð´Ð»Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ Ñ€ÐµÑ‡Ð¸
        exit(0)
        

    elif "Ð¿Ñ€Ð¸Ð²ÐµÑ‚" in cmd:
        print("ðŸ‘‹ ÐŸÑ€Ð¸Ð²ÐµÑ‚! ÐšÐ°Ðº Ñ Ð¼Ð¾Ð³Ñƒ Ð¿Ð¾Ð¼Ð¾Ñ‡ÑŒ?")
        tts.va_speak("ÐŸÑ€Ð¸Ð²ÐµÑ‚! ÐšÐ°Ðº Ñ Ð¼Ð¾Ð³Ñƒ Ð¿Ð¾Ð¼Ð¾Ñ‡ÑŒ?")
        pause(1)  # ÐŸÐ°ÑƒÐ·Ð° Ð´Ð»Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ Ñ€ÐµÑ‡Ð¸

    elif "Ð²ÐºÐ»ÑŽÑ‡Ð¸ ÑÐ²ÐµÑ‚" in cmd:
        print("ðŸ’¡ ÐšÐ¾Ð¼Ð°Ð½Ð´Ð°: Ð²ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ ÑÐ²ÐµÑ‚")
        tts.va_speak("Ð’ÐºÐ»ÑŽÑ‡Ð°ÑŽ ÑÐ²ÐµÑ‚.")
        pause(1) # ÐŸÐ°ÑƒÐ·Ð° Ð´Ð»Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ Ñ€ÐµÑ‡Ð¸

    elif "Ð¾Ñ‚ÐºÑ€Ð¾Ð¹ Ð¾ÐºÐ½Ð¾" in cmd:
        print("ðŸªŸ ÐšÐ¾Ð¼Ð°Ð½Ð´Ð°: Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¾ÐºÐ½Ð¾")
        tts.va_speak("ÐžÑ‚ÐºÑ€Ñ‹Ð²Ð°ÑŽ Ð¾ÐºÐ½Ð¾.")
        pause(1)  # ÐŸÐ°ÑƒÐ·Ð° Ð´Ð»Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ Ñ€ÐµÑ‡Ð¸

    else:
        print(f"ðŸ¤– ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð°: {cmd}")
        tts.va_speak(f"Ð½ÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð°")
        pause(1)  # ÐŸÐ°ÑƒÐ·Ð° Ð´Ð»Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ Ñ€ÐµÑ‡Ð¸
        return False
    
    return True

SILENCE_TIMEOUT = 10  # ÑÐµÐºÑƒÐ½Ð´

if __name__ == "__main__":

    print("ðŸŽ¤ Ð“Ð¾Ñ‚Ð¾Ð² Ðº Ñ€Ð°Ð±Ð¾Ñ‚Ðµ!")

    while True:
        
        try:
            print("ðŸ”Š ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð°ÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ð¸...")
            attemps = 0
            last_voice_time = time.time()  # Ð¢Ð°Ð¹Ð¼ÐµÑ€ Ð´Ð»Ñ Ð¾Ñ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ñ Ñ‚Ð¸ÑˆÐ¸Ð½Ñ‹

            if  recognize_wake_up():
                last_voice_time = time.time()
                print("ðŸŸ¢ ÐÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ: Ð”Ð°, ÑÑÑ€!")

                while True:
                    
                        # Ð¶Ð´ÐµÐ¼ Ð½Ð¾Ð²ÑƒÑŽ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ Ð¸Ð· Ð¾Ñ‡ÐµÑ€ÐµÐ´Ð¸ Ñ Ñ‚Ð°Ð¹Ð¼Ð°ÑƒÑ‚Ð¾Ð¼, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¼Ð¾Ð¶Ð½Ð¾ Ð±Ñ‹Ð»Ð¾ Ñ€ÐµÐ°Ð³Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ
                        pause(0.5)  # Ð½ÐµÐ±Ð¾Ð»ÑŒÑˆÐ°Ñ Ð¿Ð°ÑƒÐ·Ð° Ð´Ð»Ñ ÑÐ½Ð¸Ð¶ÐµÐ½Ð¸Ñ Ð½Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸
                        if time.time() - last_voice_time > SILENCE_TIMEOUT:
                            print("â±", SILENCE_TIMEOUT, "ÑÐµÐºÑƒÐ½Ð´. Ð—Ð°Ð²ÐµÑ€ÑˆÐ°ÐµÐ¼.")
                            break

                        text = recognize_continuous()
                        print("ðŸ§ª Ð“Ð¾Ð²Ð¾Ñ€Ð¸Ñ‚ÑÑ:", text)
                        if not text.strip():
                            continue
                        last_voice_time = time.time() #Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ñ‚Ð°Ð¹Ð¼ÐµÑ€ Ð½Ð° Ð·Ð²ÑƒÐº
                        print(f"ðŸ“¥ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¾: {text}")
                        # Ð Ð°Ð·Ð±Ð¸Ð²Ð°ÐµÐ¼ Ð½Ð° Ñ„Ñ€Ð°Ð·Ñ‹-Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
                        commands = [cmd.strip() for cmd in re.split(r'\s+Ð·Ð°Ñ‚ÐµÐ¼\s+|\s+Ð¿Ð¾ÑÐ»Ðµ\s+|\s+Ð¸\s+|[.,;!?]', text) if cmd.strip()]  # Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ text, Ð° Ð½Ðµ cmd

                        for cmd in commands:
                            print(f"ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹: {cmd}")
                            cmd = cmd.lower()  # ÐŸÑ€Ð¸Ð²Ð¾Ð´Ð¸Ð¼ Ðº Ð½Ð¸Ð¶Ð½ÐµÐ¼Ñƒ Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ñƒ Ð´Ð»Ñ ÑƒÐ½Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸
                            pause(0.1)

                            if not process_command(cmd):
                                attemps += 1
                                if attemps >= 3:
                                    break
                                
                        
                    
        except ValueError or Exception as err:
            print("\nâ›” ÐŸÑ€ÐµÑ€Ð²Ð°Ð½Ð¾ Ð°Ð²Ð°Ñ€Ð¸Ð¹Ð½Ð¾:\n")
            print(f"Unexpected {err=}, {type(err)=}")
            raise
                    